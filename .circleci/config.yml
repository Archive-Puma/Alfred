version: 2
jobs:
  make_build:
    docker:
      - image: fpco/stack-build
    steps:
      - checkout
      - run:
          name: Check GHC
          command: ghc --version
      - run:
          name: Configure
          command: make configure
      - run:
          name: Build
          command: make build
      - run:
          name: Clean
          command: make clean
  cabal_build:
    docker:
      - image: fpco/stack-build
    steps:
      - checkout
      - run:
          name: Check GHC and Cabal
          command: |
            ghc --version
            cabal --version
      - run:
          name: Configure Cabal
          command: |
            cabal update
            cabal install hspec hspec-discover hspec-expectations
      - run:
          name: Build Program
          command: cabal build
      - save_cache:
          key: alfred-binary-{{ checksum ".circleci/config.yml" }}-{{ checksum "src/core/Parser.hs" }}
          paths:
            - example
            - dist/build/alfred/alfred

  test_binary:
    docker:
      - image: fpco/stack-build
    steps:
      - checkout
      - restore_cache:
          keys:
            - alfred-binary-{{ checksum ".circleci/config.yml" }}-{{ checksum "src/core/Parser.hs" }}
      - run:
          name: Linking Alfred
          command: sudo ln -s $PWD/dist/build/alfred/alfred /usr/bin/alfred
      - run:
          name: Alfred Version
          command: |
            alfred -v
            alfred --version
      - run:
          name: Alfred Help
          command: |
            alfred -h
            alfred --help
      - run:
          name: Hello World
          command: alfred example/holamundo.alf
      - run:
          name: Variables
          command: alfred example/variables.alf
      - run:
          name: Momentos
          command: alfred example/momentos.alf
      - run:
          name: Momentos Inversos
          command: alfred example/momentos_inversos.alf
  test_code:
    docker:
      - image: fpco/stack-build
    steps:
      - checkout
      - run:
          name: Cabal Dependencies
          command: |
            cabal update
            cabal install hspec hspec-discover hspec-expectations
      - run:
          name: Alfred Cabal Tests
          command: cabal test
      - run:
          name: Alfred Binary Tests
          command: ./dist/build/alfred-test/alfred-test

  # Alexa Version - Unit Test
  # https://circleci.com/docs/2.0/language-javascript/
  alexa-unit_test:
    docker:
      - image: circleci/node
    steps:
      # Clone the source code
      - checkout
      # Update NPM to latest version
      - run:
        - name: Update NPM
        - command: sudo npm install --global npm@latest
      # Lambda Directory
      - run:
        - name: Lambda Directory
        - command: cd lambda/us-east-1_ask-custom-alexa-default
      # Restore dependencies
      - restore_cache:
        key: dependencies-{{ checksum "package.json" }}
      # Upgrade/Install NPM modules
      - run:
        - name: NPM Install
        - command: npm install
      # Save updated dependencies
      - save_cache:
        - key: dependencies-{{ checksum "package.json" }}
        - paths: ./node_modules
      # Run the Unit Tests
      - run:
        - name: Unit Tests
        - command: npm test


workflows:
  version: 2
  builds:
    jobs:
      # HASKELL
      - make_build:
          filters:
            branches:
              only: haskell
      - cabal_build:
          filters:
            branches:
              only: haskell
      - test_binary:
          requires:
            - make_build
            - cabal_build
      - test_code:
          requires:
            - make_build
            - cabal_build
      # ALEXA
      - alexa-unit_test:
          filters:
            branches:
              only: alexa
