version: 2
jobs:
  make_build:
    docker:
      - image: fpco/stack-build
    steps:
      - checkout
      - run:
          name: Check GHC
          command: ghc --version
      - run:
          name: Configure
          command: make configure
      - run:
          name: Build
          command: make build
      - run:
          name: Clean
          command: make clean
  cabal_build:
    docker:
      - image: fpco/stack-build
    steps:
      - checkout
      - run:
          name: Check GHC and Cabal
          command: |
            ghc --version
            cabal --version
      - run:
          name: Configure Cabal
          command: |
            cabal update
            cabal configure --enable-tests
      - run:
          name: Build Program
          command: cabal build
      - save_cache:
          key: alfred-binary
          paths:
            - dist/build/alfred/alfred
      - save_cache:
          key: alfred_examples
          paths:
            - example

  test_binary:
    docker:
      - image: fpco/stack-build
    steps:
      - restore_cache:
          keys:
            - alfred-binary
            - alfred_examples
      - run:
          name: Linking Alfred
          command: sudo ln -s $PWD/dist/build/alfred/alfred /usr/bin/alfred
      - run:
          name: Alfred Version
          command: |
            alfred -v
            alfred --version
      - run:
          name: Alfred Help
          command: |
            alfred -h
            alfred --help
      - run:
          name: Discover
          command: |
            pwd
            ls -Rla
      - run:
          name: Hello World
          command: alfred example/holamundo.alf
      - run:
          name: Variables
          command: alfred example/variables.alf

workflows:
  version: 2
  builds:
    jobs:
      - make_build:
          filters:
            branches:
              only: master
      - cabal_build:
          filters:
            branches:
              only: master
      - test_binary:
          requires:
            - make_build
            - cabal_build
